<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MEHTA TOSS BOOK ‚Äî Dashboard</title>
<style>
  :root{ --bg:#0b1220; --card:#0f1724; --accent:#00aaff; --muted:#9aa6b2; --ok:#10b981; --err:#ef4444; }
  body{ margin:0; font-family:Inter,Roboto,Arial,sans-serif; background:var(--bg); color:#e6eef6; padding:18px; }
  .wrap{ max-width:980px; margin:0 auto; }
  header{ display:flex; align-items:center; gap:12px; margin-bottom:14px; }
  .logo{ width:56px; height:56px; border-radius:10px; background:linear-gradient(180deg,#07101a,#0f1724); display:flex; align-items:center; justify-content:center; font-weight:800; color:var(--accent); box-shadow:0 8px 24px rgba(0,0,0,0.6); }
  h1{ margin:0; font-size:18px; }
  .row{ display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
  .card{ background:var(--card); padding:12px; border-radius:10px; flex:1; min-width:260px; box-shadow:0 6px 18px rgba(0,0,0,0.6); }
  label{ display:block; font-size:13px; color:var(--muted); margin-top:8px; }
  input, select, button, textarea{ width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:#091016; color:#e6eef6; font-size:14px; box-sizing:border-box; }
  button{ cursor:pointer; background:var(--accent); border:none; color:#001; font-weight:700; }
  button.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--accent); }
  button.warn{ background:#f59e0b; color:#07101a; }
  .muted{ color:var(--muted); font-size:13px; }
  .dp-area{ white-space:pre-wrap; font-family:monospace; background:#071019; border:1px solid rgba(255,255,255,0.03); padding:10px; border-radius:8px; min-height:120px; overflow:auto; color:#8fffa1; }
  .msg { font-size:13px; margin-top:8px; }
  .ok{ color:var(--ok); }
  .err{ color:var(--err); }
  footer{ text-align:center; color:var(--muted); margin-top:18px; font-size:13px; }
  @media(max-width:760px){ .row{ flex-direction:column } .card{ min-width:unset } }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">MTB</div>
      <div>
        <h1>MEHTA TOSS BOOK ‚Äî Admin Dashboard</h1>
        <div class="muted">Single-page admin ‚Äî add players, create match, place bets, settle, void, DP list</div>
      </div>
    </header>

    <!-- CONFIG: set your Apps Script URL here (replace only if you deployed new URL) -->
    <script>
      const API = "https://script.google.com/macros/s/AKfycbzpyKzWNHRR4XOIbz7IxSYceanpn2e3K50PdQFFkteF2WAZLuTt7XZwjTaICzgpadfp/exec";
      function q(obj){
        const p = Object.entries(obj || {}).map(([k,v])=> encodeURIComponent(k) + "=" + encodeURIComponent(v)).join("&");
        return p;
      }
      async function apiGet(action, params = {}){
        const url = API + "?action=" + encodeURIComponent(action) + (Object.keys(params).length ? "&" + q(params) : "");
        try {
          const res = await fetch(url, { method: "GET", mode: "cors", credentials: "omit" });
          const j = await res.json();
          return j;
        } catch (err) {
          return { success:false, error: String(err) };
        }
      }
    </script>

    <div class="row">
      <div class="card">
        <strong>‚ûï Add Player</strong>
        <label>DP Number</label>
        <input id="add_dp" placeholder="e.g. 1001">
        <label>Player Name (optional)</label>
        <input id="add_name" placeholder="e.g. Kiran">
        <button id="btnAdd">Add Player</button>
        <div id="outAdd" class="msg"></div>
      </div>

      <div class="card">
        <strong>üí∞ Update Balance (¬±)</strong>
        <label>DP Number</label>
        <input id="bal_dp" placeholder="DP number">
        <label>Amount (positive or negative)</label>
        <input id="bal_amount" placeholder="e.g. 1000 or -500">
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="btnBal" style="flex:1">Apply</button>
          <button id="btnRefreshDP" class="ghost" style="flex:1">Refresh DP List</button>
        </div>
        <div id="outBal" class="msg"></div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <strong>üéÆ Create Match</strong>
        <label>League / Tag (optional)</label>
        <input id="match_league" placeholder="e.g. IPL 2025">
        <div style="display:flex;gap:8px;">
          <div style="flex:1">
            <label>Team A</label>
            <input id="teamA" placeholder="Team A">
          </div>
          <div style="flex:1">
            <label>Team B</label>
            <input id="teamB" placeholder="Team B">
          </div>
        </div>
        <label>Odds A (e.g. 0.95)</label>
        <input id="oddsA" placeholder="2.0 or 0.95">
        <label>Odds B (e.g. 0.97)</label>
        <input id="oddsB" placeholder="2.0 or 0.97">
        <button id="btnCreate" class="">Create Match</button>
        <div id="outCreate" class="msg"></div>
      </div>

      <div class="card">
        <strong>üèè Place Bet (HOLD)</strong>
        <label>Match ID (from Create Match response)</label>
        <input id="bet_matchId" placeholder="Match ID">
        <label>DP Number</label>
        <input id="bet_dp" placeholder="1001">
        <label>Team (Team A or Team B ‚Äî exact name)</label>
        <input id="bet_team" placeholder="Team A">
        <label>Stake</label>
        <input id="bet_amount" type="number" placeholder="100">
        <label>Odds (same used by admin)</label>
        <input id="bet_odds" placeholder="0.95">
        <button id="btnBet">Place Bet (HOLD)</button>
        <div id="outBet" class="msg"></div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <strong>‚úÖ Settle Match</strong>
        <label>Match ID</label>
        <input id="settle_matchId" placeholder="Match ID">
        <label>Result</label>
        <select id="settle_result">
          <option value="">--select--</option>
          <option value="win">Settle Win</option>
          <option value="loss">Settle Loss</option>
          <option value="void">Void Match</option>
        </select>
        <label>Winner team (required for <em>win</em>)</label>
        <input id="settle_winner" placeholder="Team A or Team B">
        <button id="btnSettle" class="warn">Apply Settlement</button>
        <div id="outSettle" class="msg"></div>
      </div>

      <div class="card">
        <strong>üìã DP List</strong>
        <div style="display:flex;gap:8px;">
          <button id="btnLoadDP" style="flex:1">Load DP List</button>
          <button id="btnCopyDP" class="ghost" style="flex:1">Copy</button>
        </div>
        <div id="dpArea" class="dp-area">DP list will appear here</div>
      </div>
    </div>

    <footer>Built for MEHTA TOSS BOOK ‚Äî single page admin</footer>
  </div>

<script>
  // UI helpers
  const $ = id => document.getElementById(id);
  function show(id, text, ok=true){
    const el = $(id);
    el.innerText = text || "";
    el.className = "msg " + (ok ? "ok" : "err");
    if(text) setTimeout(()=>{ if(el.innerText === text) el.innerText = ""; }, 3000);
  }

  // Add Player
  $("btnAdd").onclick = async () => {
    const dp = $("add_dp").value.trim();
    const name = $("add_name").value.trim();
    if(!dp){ show("outAdd","DP required",false); return; }
    show("outAdd","...",true);
    const res = await apiGet("addPlayer", { dp, name });
    if(res && res.success !== false) show("outAdd","Added: "+dp,true);
    else show("outAdd","Error: "+(res && (res.error || res.message) || "failed"),false);
    await loadDP();
  };

  // Update Balance
  $("btnBal").onclick = async () => {
    const dp = $("bal_dp").value.trim();
    const amount = Number($("bal_amount").value || 0);
    if(!dp){ show("outBal","DP required",false); return; }
    show("outBal","...",true);
    const res = await apiGet("updateBalance", { dp, amount });
    if(res && res.success !== false) show("outBal","Updated",true);
    else show("outBal","Error: "+(res && (res.error || res.message) || "failed"),false);
    await loadDP();
  };

  // Refresh DP list button
  $("btnRefreshDP").onclick = loadDP;
  $("btnLoadDP").onclick = loadDP;

  // Copy DP
  $("btnCopyDP").onclick = () => {
    const txt = $("dpArea").innerText;
    navigator.clipboard.writeText(txt).then(()=> alert("Copied DP list"));
  };

  // Create Match
  $("btnCreate").onclick = async () => {
    const teamA = $("teamA").value.trim();
    const teamB = $("teamB").value.trim();
    const league = $("match_league").value.trim();
    const oddsA = $("oddsA").value.trim();
    const oddsB = $("oddsB").value.trim();

    if(!teamA || !teamB){ show("outCreate","Teams required",false); return; }
    show("outCreate","...",true);
    const res = await apiGet("createMatch",{ league, teamA, teamB, oddsA, oddsB });
    if(res && res.success !== false){
      show("outCreate","Match created: " + (res.matchId || "ID returned"), true);
      // populate matchId field for convenience
      $("bet_matchId").value = res.matchId || "";
      $("settle_matchId").value = res.matchId || "";
    } else {
      show("outCreate","Error: "+(res && (res.error || res.message) || "failed"),false);
    }
  };

  // Place Bet
  $("btnBet").onclick = async () => {
    const matchID = $("bet_matchId").value.trim();
    const dp = $("bet_dp").value.trim();
    const team = $("bet_team").value.trim();
    const amount = $("bet_amount").value.trim();
    const odds = $("bet_odds").value.trim();
    if(!matchID||!dp||!team||!amount){ show("outBet","Fill all fields",false); return; }
    show("outBet","...",true);
    const res = await apiGet("placeBet", { matchId: matchID, dp, team, amount, odds });
    if(res && res.success !== false) show("outBet","Bet placed (HOLD)",true);
    else show("outBet","Error: "+(res && (res.error || res.message) || "failed"),false);
  };

  // Settle
  $("btnSettle").onclick = async () => {
    const matchId = $("settle_matchId").value.trim();
    const result = $("settle_result").value;
    const winner = $("settle_winner").value.trim();

    if(!matchId || !result){ show("outSettle","Match ID + result required",false); return; }
    if(result === "win" && !winner){ show("outSettle","Winner required for win",false); return; }

    show("outSettle","...",true);
    // settleMatch expects matchId + result + winner (winner optional for void/loss)
    const res = await apiGet("settleMatch", { matchId, result, winner });
    if(res && res.success !== false) {
      show("outSettle","Settled: "+result,true);
      await loadDP();
    } else show("outSettle","Error: "+(res && (res.error || res.message) || "failed"),false);
  };

  // Void match shortcut (if admin wants quick void)
  // Not required, since result=void works via settle

  // Load DP list
  async function loadDP(){
    $("dpArea").innerText = "Loading...";
    const res = await apiGet("getDPList", {});
    if(!res || res.success === false){ $("dpArea").innerText = "Failed to load DP list: " + (res && (res.error||res.message) || "error"); return; }
    const rows = res.players || [];
    // rows expected as array of [DP, Name, Balance] OR [dp,balance] depending on sheet schema
    let text = `MEHTA TOSS BOOK DP LIST ‚Äî ${new Date().toLocaleString()}\n\n`;
    if(rows.length === 0){ text += "No players\n"; }
    for(let i=0;i<rows.length;i++){
      const r = rows[i];
      // handle shape: [dp,name,balance] or [dp,balance] or [dp,0]
      const dp = r[0] !== undefined ? String(r[0]) : "";
      const name = r[1] !== undefined && isNaN(r[1]) ? String(r[1]) : "-";
      const bal = r[2] !== undefined ? r[2] : (r[1] !== undefined && !isNaN(r[1]) ? r[1] : 0);
      text += `${i+1}) ${name} ‚Äî ${dp} ‚Äî ‚Çπ${bal}\n`;
    }
    $("dpArea").innerText = text;
  }

  // small helper for initial load
  (async function init(){ await loadDP(); })();
</script>
</body>
</html>
